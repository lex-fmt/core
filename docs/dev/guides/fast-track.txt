Lex Format Fasttrack


This is a high level overview of how the Lex parser is designed.

1. Processing Management

	The lex/transforms module provides a composable transform system for processing stages.

	Key components:
		- Transform<I, O>: Type-safe transformations that chain via .then()
		- Runnable trait: Interface for individual processing stages
		- Static lazy transforms: Pre-built pipelines (LEXING, STRING_TO_AST, etc.)
		- DocumentLoader: Universal API for file/string loading and transform execution

	This system enables:
		- Type-safe stage composition with compiler verification
		- Reusable transforms across CLI, tests, and library code
		- Easy access to specific stages or full pipelines
		- Custom transform chains for specialized needs


2. Data Structures and Processing Stages:

	Processing flows through four main stages via the transform system:

	1. Core Tokenization (CORE_TOKENIZATION)
		String → Vec<(Token, Range<usize>)>
		- Uses logos crate for lexical analysis
		- Produces flat token stream with byte ranges

	2. Semantic Indentation (part of LEXING)
		Vec<(Token, Range)> → Vec<(Token, Range)>
		- Adds Indent/Dedent tokens based on whitespace
		- Groups tokens into logical line structures

	3. Parsing to IR (TO_IR)
		String → ParseNode
		- Performs semantic analysis
		- Returns intermediate representation (IR) tree
		- IR nodes specify which AST nodes to create and which tokens to use

	4. AST Building (STRING_TO_AST)
		String → Document
		- Complete pipeline: tokenization → lexing → parsing → building
		- Walks IR tree creating final AST nodes
		- Translates byte ranges to AST Location objects

	These stages compose via Transform<I, O>.then() chains.


3. Parser Design:

	Line-based declarative grammar engine:

		- Receives flat Vec<(Token, Range<usize>)> from lexing stage
		- Groups tokens into logical lines and indentation scopes
		- Classifies lines (SubjectLine, ListLine, etc.) as LineContainer nodes
		- Uses declarative regex patterns to match container sequences
		- Emits IR nodes for AST construction

	The grammar is simple enough for ordered regex expressions.

	Key files:
		- src/lex/parsing/engine.rs (main parsing entry point)
		- src/lex/parsing/ir.rs (IR node definitions)
		- src/lex/transforms/stages/parsing.rs (parsing transform stage)
		- src/lex/building/ (AST node construction from IR)
