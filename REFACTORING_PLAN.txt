PARSER MODULE REFACTORING PLAN
==============================

SCOPE: Clean up duplicate code and redundant functions in src/txxt_nano/parser/

CURRENT STATE (after Step 1):
  - Duplicate text utilities removed from conversion/text.rs
  - conversion/basic.rs updated to import from ast_conversion.rs
  - conversion/text.rs deleted
  - All tests passing

REFACTORING PHASES
==================


PHASE 1: Eliminate conversion/basic.rs [PRIORITY: MEDIUM]
===========================================================

PROBLEM:
  - conversion/basic.rs is incomplete (missing position variants)
  - Only used by internal parser.rs test code, not production api.rs
  - Causes confusion about which convert_document to use
  - Maintains duplicate of functions that ast_conversion.rs already has

SOLUTION:
  Delete conversion/basic.rs entirely and consolidate imports

DELETIONS:
  - src/txxt_nano/parser/conversion/basic.rs (154 lines)
  - pub mod basic; from src/txxt_nano/parser/conversion/mod.rs

UPDATES:
  - src/txxt_nano/parser/parser.rs:
    FROM: use super::conversion::basic::{convert_document, convert_paragraph};
    TO:   use super::ast_conversion::{convert_document, convert_paragraph};

  - src/txxt_nano/parser/parser.rs:
    FROM: use super::ast_conversion::convert_document_with_positions;
    TO:   (already imports from ast_conversion, no change needed)

RESULT:
  - ast_conversion.rs becomes single source of truth for all conversion functions
  - parser.rs imports only from ast_conversion.rs for conversions
  - Reduces confusion about conversion API
  - Removes 154 lines of duplicate code

AFTER:
  conversion/mod.rs only contains:
    pub mod helpers;


PHASE 2: Consolidate api.rs and parser.rs parse functions [PRIORITY: MEDIUM]
==============================================================================

PROBLEM:
  - parser.rs contains duplicate parse_with_source() functions (lines 278-308)
  - api.rs contains identical parse_with_source() functions (lines 18-40)
  - Both do same thing: call document().parse() then convert_document()
  - Violates DRY principle

CURRENT:
  api.rs:parse_with_source()
    → document().parse()
    → convert_document()

  parser.rs:parse_with_source()
    → document().parse()
    → convert_document()  [currently from conversion/basic.rs, would be from ast_conversion]

SOLUTION:
  Option A: Delete parser.rs versions, make them call api.rs (Recommended)
  Option B: Move to shared module/file

RECOMMENDED: Option A

DELETIONS:
  - src/txxt_nano/parser/parser.rs line 278-308: parse_with_source() function
  - src/txxt_nano/parser/parser.rs line 292-298: parse_with_source_positions() function

UPDATES:
  - src/txxt_nano/parser/parser.rs:
    Replace the two deleted functions with calls to api::

    FROM:
      pub fn parse_with_source(...) -> Result<Document, Vec<ParserError>> {
          let doc_with_spans = document().parse(tokens_with_spans)?;
          Ok(convert_document(source, doc_with_spans))
      }

    TO:
      pub fn parse_with_source(
          tokens_with_spans: Vec<TokenSpan>,
          source: &str,
      ) -> Result<Document, Vec<ParserError>> {
          super::api::parse_with_source(tokens_with_spans, source)
      }

    (Same pattern for parse_with_source_positions)

RESULT:
  - Single source of truth for parsing entry points
  - Removes code duplication
  - Clarifies that parser.rs functions are wrappers/re-exports

AFTER:
  All parse_* functions call through to api.rs
  No duplicate logic


PHASE 3: Clean up unused/future code in parser.rs [PRIORITY: LOW]
===================================================================

PROBLEM:
  - ContainerType enum (lines 48-59) marked "not currently used"
  - paragraph_recursive() function marked "kept for future improvements"
  - #[allow(dead_code)] markers indicate these aren't ready
  - Clutter the main parser file

SOLUTION:
  Move to dedicated future-features branch or remove entirely
  For now: Leave in place with clear documentation

DELETIONS (Optional):
  - src/txxt_nano/parser/parser.rs line 48-59: ContainerType enum
  - src/txxt_nano/parser/parser.rs line 63-?: paragraph_recursive() function

RECOMMENDATION:
  Defer to separate PR. Mark with explicit TODO comments if keeping:

    // TODO: Feature - Container restriction system (issue #XXX)
    enum ContainerType { ... }

  This phase requires design discussion on future container features.


PHASE 4: Clean up unused conversion/helpers.rs [PRIORITY: LOW]
===============================================================

PROBLEM:
  - spans_to_span_position() marked #[allow(dead_code)]
  - nested_spans_to_span_position() marked #[allow(dead_code)]
  - Kept for future position conversion improvements
  - Not currently used

SOLUTION:
  Keep as-is for now. Future improvements to position handling will use these.

NO CHANGES - Defer to position-handling improvement phase


PHASE 5: Remove temporary analysis files [PRIORITY: CLEANUP]
==============================================================

DELETIONS:
  - PARSER_DUPLICATE_ANALYSIS.txt (this file created during analysis)
  - REFACTORING_PLAN.txt (this plan document)

OR: Move to docs/ directory if keeping for reference

RECOMMENDATION:
  Delete after refactoring complete and merged
  Or archive to git history with final commit message


IMPLEMENTATION ORDER
====================

1. PHASE 1: Delete conversion/basic.rs (SAFE - isolated module)
   - Delete file
   - Update conversion/mod.rs
   - Update parser.rs imports
   - Run tests
   - Commit

2. PHASE 2: Consolidate parser.rs parse functions (SAFE - api.rs has identical logic)
   - Replace 2 functions in parser.rs with wrappers to api.rs
   - Run tests
   - Commit

3. PHASE 3: Future code cleanup (DEFER - requires design input)
   - Document with TODO comments
   - Link to GitHub issues
   - Add to project backlog

4. PHASE 4: Future helpers cleanup (DEFER - keep for future improvements)
   - No action needed

5. PHASE 5: Delete analysis files (CLEANUP)
   - Remove temporary documents
   - Commit


COMMIT MESSAGES
===============

Phase 1:
  refactor: Delete conversion/basic.rs and consolidate to ast_conversion.rs

  conversion/basic.rs was incomplete (missing position variants) and only
  used by internal test code. ast_conversion.rs already contains all needed
  conversion functions. Consolidate all imports to use ast_conversion.rs
  as single source of truth for AST conversion.

  Removes 154 lines of duplicate/incomplete code.

Phase 2:
  refactor: Consolidate parse_with_source functions in parser.rs

  parser.rs contained duplicate parse_with_source() and parse_with_source_positions()
  functions that were identical to api.rs versions. Replace with wrappers
  to api.rs to eliminate duplication and clarify that parser.rs functions
  are re-exports for internal use.

  Removes 40 lines of duplicate code.


TESTING STRATEGY
================

After each phase:
  1. cargo test --lib parser (10s)
  2. cargo test --all (full test suite)
  3. Verify all 58+ parser tests pass

After Phase 1+2:
  - All parser tests should pass
  - No functional changes to public API
  - Internal structure cleaner


ESTIMATE
========

Phase 1: 15 minutes (1 file delete, 1 import update, test)
Phase 2: 15 minutes (2 function replacements, test)
Total:   30 minutes active work


AFTER REFACTORING - NEW STATE
=============================

Files removed:
  - conversion/basic.rs (154 lines)

Files updated:
  - parser.rs (3-4 line changes)
  - conversion/mod.rs (1 line removal)

Net lines removed: 155+

Module structure:
  parser/
  ├── api.rs (40 lines) - PUBLIC API entry points
  ├── ast_conversion.rs (465 lines) - AST conversion functions [CANONICAL]
  ├── combinators.rs (186 lines) - Parser combinators
  ├── conversion/
  │   ├── mod.rs (6 lines) - Re-export helpers
  │   └── helpers.rs (75 lines) - Helper utilities
  ├── document.rs (170 lines) - Document parser
  ├── intermediate_ast.rs (71 lines) - Intermediate AST structures
  ├── labels.rs (155 lines) - Label parsing
  ├── parameters.rs (254 lines) - Parameter parsing
  ├── parser.rs (2400+ lines) - Main parser + internal utilities/tests
  └── tests.rs (135 lines) - Integration tests

Flow:
  External API → api.rs → ast_conversion.rs → Document (final)
  No more imports from conversion/basic.rs
  No more confusion about which converter to use
