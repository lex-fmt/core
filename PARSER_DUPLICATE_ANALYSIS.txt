PARSER MODULE DUPLICATE CODE ANALYSIS
=====================================

STATUS: Initial analysis complete
BRANCH: refac/ast


EXACT DUPLICATES FOUND
======================

Three text utility functions are duplicated IDENTICALLY in two locations:

File 1: src/txxt_nano/parser/ast_conversion.rs
  Lines 14-76:
    - extract_text() (lines 14-22)
    - extract_line_text() (lines 24-39)
    - reconstruct_raw_content() (lines 41-76)

File 2: src/txxt_nano/parser/conversion/text.rs
  Lines 8-71:
    - extract_text() (lines 8-15)
    - extract_line_text() (lines 17-32)
    - reconstruct_raw_content() (lines 34-71)

Difference: Only param type syntax differs (std::ops::Range vs Range import)
Logic: 100% identical


CURRENT IMPORT CHAIN
====================

conversion/text.rs (contains duplicate)
  ↓ imports from
conversion/basic.rs (imports extract_* functions from conversion/text.rs)
  ↓ imported by
parser.rs (but doesn't use extract_* directly)

ast_conversion.rs (contains original)
  ↓ imports directly from conversion/helpers.rs for span conversion
  ↓ imported by
api.rs (uses convert_document, convert_document_with_positions)
parser.rs (uses convert_document, convert_document_with_positions)
tests.rs (uses convert_paragraph)


ACTIVE USAGE
============

The text extraction functions are USED in:
  1. ast_conversion.rs line 84: uses extract_text(), extract_line_text(), reconstruct_raw_content()
  2. conversion/basic.rs line 11: imports them from conversion/text.rs
     - convert_annotation() line ~40: uses extract_text()
     - convert_foreign_block() line ~100: uses extract_line_text(), reconstruct_raw_content()
     - (and other converters)

Current imports:
  - api.rs: uses ast_conversion.rs::convert_document*
  - parser.rs: uses ast_conversion.rs::convert_document_with_positions
  - parser.rs: uses conversion/basic.rs::convert_document (with annotation #[allow(unused_imports)])
  - tests.rs: uses ast_conversion.rs::convert_paragraph


CONSOLIDATION OPTION 1: Delete conversion/text.rs (LOW RISK)
=============================================================

Keep the canonical copy in: ast_conversion.rs
Delete: conversion/text.rs (71 lines)

Changes needed:
  1. conversion/basic.rs line 11:
     FROM: use super::text::{extract_line_text, extract_text, reconstruct_raw_content};
     TO:   use super::super::ast_conversion::{extract_line_text, extract_text, reconstruct_raw_content};

  2. conversion/mod.rs:
     Remove: pub(crate) mod text;

  3. Delete file: conversion/text.rs

After this consolidation:
  - ast_conversion.rs remains the canonical source
  - conversion/basic.rs gets its utilities from ast_conversion.rs
  - No code changes to any calling code
  - Removes 71 lines of dead duplication


CONSOLIDATION OPTION 2: Move to conversion/ submodule (MEDIUM RISK)
===================================================================

Keep the canonical copy in: conversion/text.rs
Delete: ast_conversion.rs extract_* functions (lines 14-76)

Changes needed:
  1. ast_conversion.rs:
     Add import at top: use super::conversion::text::{extract_line_text, extract_text, reconstruct_raw_content};
     Remove lines 14-76 (function definitions)

  2. conversion/mod.rs:
     Ensure text is exported: pub(crate) mod text;

  3. Keep conversion/text.rs as is

After this:
  - conversion/text.rs is canonical source
  - Both ast_conversion.rs and conversion/basic.rs import from it
  - More consistent with the refactor-to-submodule intent
  - Requires updating imports in ast_conversion.rs


RECOMMENDATION
==============

Option 1 (Delete conversion/text.rs) is recommended as first step because:
  - Lowest risk - no code changes to callers
  - Single commit: file deletion + 1 line change
  - Preserves working code flow
  - Can run tests immediately

Then Option 2 (move to conversion/) can be considered as part of larger refactor
to complete the intent of refactor/ast branch.


UNRELATED FINDINGS (not duplicates, but refactoring artifacts)
==============================================================

1. conversion/basic.rs marked "for future improvements"
   - In parser.rs line 15
   - Used by convert_document() but basic version lacks position variants
   - ast_conversion.rs has the position-preserving versions

2. parser.rs parser module:
   - Line 37 #[allow(clippy::module_inception)]
   - Flags: module named parser contains submodule with same name
   - Not a code quality issue, just indicates unusual structure

3. Dead code markers (intentional, not problems):
   - intermediate_ast.rs structures marked #[allow(dead_code)]
   - Used internally by span collection system
   - Markers are defensive/correct

4. Unused enums/functions (intentional placeholders):
   - parser.rs ContainerType enum (lines 48-59) - for future container restrictions
   - parser.rs paragraph_recursive() function - kept for improvements


NEXT STEPS
==========

1. Run: cargo test (baseline)
2. Apply Option 1: Delete conversion/text.rs + update conversion/basic.rs import
3. Run: cargo test (verify no regressions)
4. Commit with message: "refactor: Remove duplicate text extraction functions from conversion/text.rs"
5. Then trace actual usage of conversion module functions (Step 2)


================================================================================
STEP 2: CONVERSION MODULE USAGE TRACE
================================================================================

ENTRY POINTS TO PARSER
======================

1. api.rs::parse_with_source()
   - PUBLIC API
   - Called by: External code (main entry point for source-based parsing)
   - Uses: convert_document() from ast_conversion.rs
   - Uses: document() from document.rs to create intermediate AST

2. api.rs::parse_with_source_positions()
   - PUBLIC API
   - Called by: External code (entry point for source-based parsing with positions)
   - Uses: convert_document_with_positions() from ast_conversion.rs
   - Uses: document() from document.rs to create intermediate AST

3. parser.rs::parse_with_source()
   - Internal duplicate of api.rs::parse_with_source()
   - Uses: convert_document() from conversion/basic.rs (NOT ast_conversion.rs!)
   - Uses: document() from document.rs

4. parser.rs::parse_with_source_positions()
   - Internal duplicate of api.rs::parse_with_source_positions()
   - Uses: convert_document_with_positions() from ast_conversion.rs
   - Uses: document() from document.rs

5. parser.rs::parse()
   - Legacy entry point (doesn't preserve source text)
   - Calls: parse_with_source()


CONVERSION FUNCTION USAGE MAP
=============================

Function: convert_document() (exists in TWO places)

  Version 1: ast_conversion.rs::convert_document()
  - Called by: api.rs line 23 (PRODUCTION)
  - Called by: parser.rs (internal test utilities)
  - Purpose: Convert intermediate AST to final AST without position info
  - Implementation: Full, with all converter functions

  Version 2: conversion/basic.rs::convert_document()
  - Imported by: parser.rs line 15 with #[allow(unused_imports)]
  - Actually called: parser.rs line 284 (but this might be test code)
  - Purpose: Same as Version 1
  - Implementation: Identical to Version 1

Function: convert_document_with_positions()

  Location: ast_conversion.rs (ONLY location)
  - Called by: api.rs line 32 (PRODUCTION)
  - Called by: parser.rs line 297 (internal)
  - Purpose: Convert intermediate AST to final AST WITH position info
  - Unique variant that conversion/basic.rs doesn't have

Function: convert_paragraph()

  Version 1: ast_conversion.rs::convert_paragraph()
  - Called by: tests.rs line 23 (TEST)

  Version 2: conversion/basic.rs::convert_paragraph()
  - Imported by: parser.rs line 15 with comment "used in tests"
  - Actually called: parser.rs line 332 (test)
  - Same implementation as Version 1

Function: extract_text(), extract_line_text(), reconstruct_raw_content()

  Location: ast_conversion.rs (canonical after consolidation)
  - Used internally by: ast_conversion.rs converters
  - Used internally by: conversion/basic.rs converters
  - Imported by: conversion/basic.rs from ast_conversion.rs


DEPENDENCY GRAPH - WHO IMPORTS WHAT
===================================

PUBLIC API (api.rs):
  ├─ imports convert_document from ast_conversion ✓
  ├─ imports convert_document_with_positions from ast_conversion ✓
  └─ imports document() from document ✓

INTERNAL WRAPPER (parser.rs):
  ├─ imports convert_document from conversion/basic ⚠️
  ├─ imports convert_paragraph from conversion/basic ⚠️
  ├─ imports convert_document_with_positions from ast_conversion ✓
  ├─ imports document() from document ✓
  └─ imports paragraph() from combinators ✓

CONVERSION/BASIC.RS:
  ├─ imports extract_text, extract_line_text, reconstruct_raw_content from ast_conversion ✓
  ├─ imports convert_parameter from parameters ✓
  └─ imports intermediate_ast types ✓

CONVERSION/HELPERS.RS:
  ├─ Used by: combinators.rs::is_text_token()
  └─ Contains helper functions for position conversion (marked #[allow(dead_code)])

COMBINATORS.RS:
  ├─ imports is_text_token from conversion/helpers ✓
  └─ Used by: document.rs for parser building ✓

TESTS.RS:
  ├─ imports convert_paragraph from ast_conversion ✓
  ├─ imports paragraph() from combinators ✓
  └─ imports parse() from api ✓


CONFUSING IMPORT SITUATION
==========================

Problem 1: Dual imports of convert_document
- api.rs uses ast_conversion.rs::convert_document
- parser.rs uses conversion/basic.rs::convert_document
- Both are identical code
- Results in TWO copies of the same logic in use

Problem 2: Missing position variants in conversion/basic.rs
- conversion/basic.rs lacks convert_document_with_positions
- Must import from ast_conversion.rs instead
- Forces parser.rs to import from two different places

Problem 3: parser.rs duplicate functions
- parser.rs defines parse_with_source() [lines 278-285]
- api.rs ALSO defines parse_with_source() [lines 18-24]
- Both do identical things
- Both call document() from document.rs
- Both should use same conversion function

Problem 4: Misleading imports
- parser.rs line 15: "use super::conversion::basic::{convert_document, convert_paragraph}"
- Marked with #[allow(unused_imports)] but IS used
- Created confusion about refactoring intent


ACTUAL PRODUCTION USAGE
=======================

Code path: External code → parse_document() → api.rs → ast_conversion.rs

parse_document() [likely in main lib]
  ↓
  api.rs::parse_with_source()
  ↓
  document().parse(tokens)
  ↓
  DocumentWithSpans
  ↓
  convert_document(source, doc_with_spans) ← FROM ast_conversion.rs
  ↓
  Document (final)

Alternative path: parse_document_with_positions() uses convert_document_with_positions()
  (also from ast_conversion.rs)


UNUSED OR REDUNDANT CODE
========================

1. conversion/basic.rs - The entire file
   - Partially redundant with ast_conversion.rs
   - Missing position-preserving variants
   - Only used by internal parser.rs (not production api.rs)
   - Could be consolidated

2. parser.rs internal parse_with_source() and parse_with_source_positions()
   - Duplicates functions in api.rs
   - Should be removed or made to call api.rs versions

3. conversion/helpers.rs span conversion functions
   - spans_to_span_position() marked #[allow(dead_code)]
   - nested_spans_to_span_position() marked #[allow(dead_code)]
   - Not currently used (kept for future)

4. parser.rs ContainerType enum
   - Marked "Not currently used - kept for future container restriction"
   - Can be removed or moved to separate feature branch

5. parser.rs paragraph_recursive()
   - Marked "Kept for future improvements"
   - Should be removed or moved to feature branch


SUMMARY OF ACTUAL FLOW
======================

When user calls parse_document(text):
1. api.rs::parse_with_source() ← PRODUCTION ENTRY
2. document().parse() → DocumentWithSpans
3. convert_document() from ast_conversion.rs ← CANONICAL
4. Final Document with extracted text

When position info needed: Uses convert_document_with_positions()
  (Both convert functions from ast_conversion.rs)

conversion/basic.rs is only used by internal test code in parser.rs
  (Should NOT be used in production)

