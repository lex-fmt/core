#!/bin/bash
#
# Generate AST files for all txxt specification files
#
# This script processes all .txxt files in docs/specs/v1 and generates
# corresponding .ast.xml files containing the AST structure in tag format.
#
# Usage:
#   ./scripts/generate-specs-asts

set -uo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SPECS_DIR="$PROJECT_ROOT/docs/specs/v1"

# Temporary files for tracking
ERROR_FILE="/tmp/txxt_ast_errors_$$.txt"
COUNT_FILE="/tmp/txxt_ast_counts_$$.txt"

# Initialize counters
echo "0" > "$COUNT_FILE"
echo "0" > "$ERROR_FILE.count"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Cleanup function
cleanup() {
    rm -f "$ERROR_FILE" "$ERROR_FILE.count" "$COUNT_FILE" 2>/dev/null || true
}
trap cleanup EXIT

echo "๐ Finding all .txxt files in docs/specs/v1..."

# Count files first
TXXT_COUNT=$(find "$SPECS_DIR" -type f -name "*.txxt" 2>/dev/null | wc -l | tr -d ' ')

if [ "$TXXT_COUNT" -eq "0" ]; then
    echo "โ No .txxt files found in $SPECS_DIR"
    exit 1
fi

echo "๐ Found $TXXT_COUNT .txxt file(s) to process"
echo ""

# Clean up existing .ast.xml files
echo "๐งน Cleaning up existing .ast.xml files..."
AST_XML_COUNT=$(find "$SPECS_DIR" -type f -name "*.ast.xml" 2>/dev/null | wc -l | tr -d ' ')

if [ "$AST_XML_COUNT" -gt "0" ]; then
    find "$SPECS_DIR" -type f -name "*.ast.xml" -delete
    echo "   Removed $AST_XML_COUNT existing .ast.xml file(s)"
else
    echo "   No existing .ast.xml files to remove"
fi
echo ""

# Change to project root to run cargo commands
cd "$PROJECT_ROOT"

# Process each file
find "$SPECS_DIR" -type f -name "*.txxt" | sort | while read -r TXXT_FILE; do
    # Get relative path from project root
    REL_PATH="${TXXT_FILE#$PROJECT_ROOT/}"
    
    # Calculate output path: same path but with .ast.xml extension
    OUTPUT_FILE="${TXXT_FILE}.ast.xml"
    
    echo -n "Processing: $REL_PATH ... "
    
    # Run the cargo command and capture output and exit code
    OUTPUT=$(cargo run --bin txxt -- "$TXXT_FILE" ast-tag 2>&1) && EXIT_CODE=0 || EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
        # Command succeeded, save output to file
        echo "$OUTPUT" > "$OUTPUT_FILE"
        echo -e "${GREEN}โ${NC}"
        # Increment success count
        SUCCESS=$(cat "$COUNT_FILE")
        echo $((SUCCESS + 1)) > "$COUNT_FILE"
    else
        # Command failed
        echo -e "${RED}โ${NC} (exit code: $EXIT_CODE)"
        # Track error file
        echo "$REL_PATH" >> "$ERROR_FILE"
        ERROR_COUNT=$(cat "$ERROR_FILE.count")
        echo $((ERROR_COUNT + 1)) > "$ERROR_FILE.count"
    fi
done

# Read final counts
SUCCESS_COUNT=$(cat "$COUNT_FILE" 2>/dev/null || echo "0")
ERROR_COUNT=$(cat "$ERROR_FILE.count" 2>/dev/null || echo "0")

# Print summary
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "Summary"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "Files generated: ${GREEN}$SUCCESS_COUNT${NC}"
echo -e "Errors: ${RED}$ERROR_COUNT${NC}"

if [ "$ERROR_COUNT" -gt 0 ] && [ -f "$ERROR_FILE" ]; then
    echo ""
    echo "Files with errors:"
    while IFS= read -r ERR_FILE; do
        echo -e "  ${RED}โ${NC} $ERR_FILE"
    done < "$ERROR_FILE"
    exit 1
else
    echo ""
    echo -e "${GREEN}โ All files processed successfully!${NC}"
    exit 0
fi
