#!/bin/bash
#
# Pre-commit hook for Rust repos
# Runs formatting, linting, and testing
#
# Usage:
#   ./scripts/pre-commit           # Run on staged files (git hook mode)
#   ./scripts/pre-commit --all     # Run on all files (manual mode)

set -e

# Dynamically determine the repo/package name from Cargo.toml
# First try to get workspace root name, then fall back to package name
if [ -f "Cargo.toml" ]; then
    # Try to extract package name first (for single-package repos)
    REPO_NAME=$(grep '^name = ' Cargo.toml | head -1 | sed 's/name = "\(.*\)"/\1/')
    
    # If no package name found, try workspace (and use directory name as fallback)
    if [ -z "$REPO_NAME" ]; then
        REPO_NAME=$(basename "$(pwd)")
    fi
else
    REPO_NAME="current repo"
fi

echo "Running pre-commit checks for $REPO_NAME..."

# 1. Check formatting
echo ""
echo "Checking code formatting..."
if ! cargo fmt -- --check; then
    echo "Formatting issues found. Run 'cargo fmt' to fix."
    exit 1
fi
echo "Formatting OK"

# 2. Run Clippy
echo ""
echo "Running Clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo "Clippy found issues!"
    exit 1
fi
echo "Clippy OK"

# 3. Build
echo ""
echo "Building..."
if ! cargo build; then
    echo "Build failed!"
    exit 1
fi
echo "Build OK"

# 4. Run tests
echo ""
echo "Running tests..."
if command -v cargo-nextest >/dev/null 2>&1; then
    if ! cargo nextest run; then
        echo "Tests failed!"
        exit 1
    fi
else
    if ! cargo test; then
        echo "Tests failed!"
        exit 1
    fi
fi
echo "Tests OK"

echo ""
echo "All pre-commit checks passed!"
