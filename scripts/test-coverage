#!/usr/bin/env bash
# Run tests with coverage report
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

# Check if cargo-tarpaulin is installed
if ! command -v cargo-tarpaulin &> /dev/null; then
    echo "Error: cargo-tarpaulin is not installed"
    echo "Install it with: cargo install cargo-tarpaulin"
    exit 1
fi

# Run tests with coverage (suppress compilation output unless error)
cargo tarpaulin \
    --out Stdout \
    --output-dir target/coverage \
    --skip-clean \
    --no-default-features \
    --workspace \
    --exclude-files 'tests/*' 'target/*' \
    2>&1 | grep -v -E '^(   Compiling|    Finished|     Running)' || true
