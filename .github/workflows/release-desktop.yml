name: Release Desktop

defaults:
  run:
    shell: bash

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to package (e.g. v0.1.12). Leave blank to use the latest release
        required: false
      target:
        description: Rust target triple to use as the source artifact (e.g. x86_64-unknown-linux-gnu)
        required: false

permissions:
  contents: read

env:
  REPO_NAME: ${{ github.repository }}
  MANUAL_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || '' }}
  MANUAL_TARGET: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target || '' }}

jobs:
  build-desktop:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        platform: [linux-x64, macos-x64, macos-arm64, windows-x64]
        include:
          - platform: linux-x64
            runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive_ext: tar.xz
            artifact_suffix: linux-x64
            lsp_name: lex-lsp
          - platform: macos-x64
            runner: macos-15-intel
            target: x86_64-apple-darwin
            archive_ext: tar.xz
            artifact_suffix: macos-x64
            lsp_name: lex-lsp
          - platform: macos-arm64
            runner: macos-latest
            target: aarch64-apple-darwin
            archive_ext: tar.xz
            artifact_suffix: macos-arm64
            lsp_name: lex-lsp
          - platform: windows-x64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            archive_ext: zip
            artifact_suffix: windows-x64
            lsp_name: lex-lsp.exe
    runs-on: ${{ matrix.runner }}
    env:
      REPO_NAME: ${{ github.repository }}
      MANUAL_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || '' }}
      MANUAL_TARGET: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target || '' }}
      BUILD_TARGET: ${{ matrix.target }}
      ARCHIVE_EXT: ${{ matrix.archive_ext }}
      ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
      LSP_NAME: ${{ matrix.lsp_name }}
    steps:
      - name: Resolve release tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG_INPUT="$MANUAL_TAG"
          if [ -n "$TAG_INPUT" ]; then
            TAG="$TAG_INPUT"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            TAG="${{ github.event.workflow_run.head_branch }}"
          else
            TAG=$(gh release list --repo "$REPO_NAME" --limit 1 --json tagName -q '.[0].tagName')
          fi
          if [ -z "$TAG" ]; then
            echo "Unable to resolve release tag" >&2
            exit 1
          fi
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"
      - name: Evaluate target filter
        id: filter
        run: |
          if [[ -n "$MANUAL_TARGET" && "$MANUAL_TARGET" != "$BUILD_TARGET" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi
      - uses: actions/checkout@v4
        if: ${{ steps.filter.outputs.skip == 'false' }}
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.ref }}
      - uses: actions/setup-node@v4
        if: ${{ steps.filter.outputs.skip == 'false' }}
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: editors/desktop/package-lock.json
      - name: Download lex-lsp artifact
        if: ${{ steps.filter.outputs.skip == 'false' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p artifacts extracted target/debug
          ARCHIVE="lex-lsp-${BUILD_TARGET}.${ARCHIVE_EXT}"
          gh release download "$RELEASE_TAG" \
            --repo "$REPO_NAME" \
            --pattern "$ARCHIVE" \
            --dir artifacts
          ASSET="artifacts/$ARCHIVE"
          if [ ! -f "$ASSET" ]; then
            echo "Artifact $ARCHIVE not found in release $RELEASE_TAG" >&2
            exit 1
          fi
          if [[ "$ASSET" == *.zip ]]; then
            unzip -q "$ASSET" -d extracted
          else
            tar -xf "$ASSET" -C extracted
          fi
          BIN_PATH=$(find extracted -type f -name 'lex-lsp*' ! -name '*README*' | head -n 1)
          if [ -z "$BIN_PATH" ]; then
            echo "lex-lsp binary not found in $ARCHIVE" >&2
            exit 1
          fi
          DEST="target/debug/${LSP_NAME}"
          cp "$BIN_PATH" "$DEST"
          chmod +x "$DEST" || true
      - name: Install dependencies
        if: ${{ steps.filter.outputs.skip == 'false' }}
        working-directory: editors/desktop
        run: npm ci
      - name: Build Electron package
        if: ${{ steps.filter.outputs.skip == 'false' }}
        working-directory: editors/desktop
        env:
          LEX_HIDE_WINDOW: "1"
          NODE_OPTIONS: --max-old-space-size=4096
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build
      - name: Upload Electron artifacts
        uses: actions/upload-artifact@v4
        if: ${{ steps.filter.outputs.skip == 'false' }}
        with:
          name: editors/desktop-${{ env.ARTIFACT_SUFFIX }}
          path: |
            editors/desktop/release/**
            editors/desktop/dist/**
          if-no-files-found: error
